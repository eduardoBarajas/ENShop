<!DOCTYPE html>
<html class="no-js" lang="zxx">
  <% include ../partials/head %>
  <style>
    .background-btn {
      background-color: #48AB3B!important;
      color: whitesmoke;
    }
    .background-btn:hover {
      background-color: tomato!important;
      color: whitesmoke;
    }
    .lds-facebook {
    display: inline-block;
    position: relative;
    width: 64px;
    height: 64px;
    }
    .lds-facebook div {
    display: inline-block;
    position: absolute;
    left: 6px;
    width: 13px;
    background: #43A047;
    animation: lds-facebook 1.2s cubic-bezier(0, 0.5, 0.5, 1) infinite;
    }
    .lds-facebook div:nth-child(1) {
        left: 6px;
        animation-delay: -0.24s;
    }
    .lds-facebook div:nth-child(2) {
        left: 26px;
        animation-delay: -0.12s;
    }
    .lds-facebook div:nth-child(3) {
        left: 45px;
        animation-delay: 0;
    }
    @keyframes lds-facebook {
        0% {
            top: 6px;
            height: 51px;
        }
        50%, 100% {
            top: 19px;
            height: 26px;
        }
    }
  </style>
  <% include ../partials/navbar %>
  <script>
      document.getElementById('carrito-id').remove();
  </script>
  <body>
    <!--Main layout-->
    <main class="mt-5 pt-4">
        <div id="main-layout" class="container wow fadeIn">
          <!-- Heading -->
          <h2 class="my-5 h2 text-center">Agregar Nuevo Producto</h2>
    
          <!--Grid row-->
          <div class="row">
    
            <!--Grid column-->
            <div class="col-md-12 mb-4">
    
              <!--Card-->
              <div class="card">
    
                <!--Card content-->
                <form class="card-body">
    
                  <!--Grid row-->
                  <div class="row">
    
                    <!--Grid column-->
                    <div class="col-md-6 mb-2">
    
                      <!--Nombre-->
                      <div class="md-form ">
                        <input type="text" id="Nombre" class="form-control">
                        <label for="Nombre" class="">Nombre</label>
                      </div>
                    </div>
                    <!--Grid column-->
    
                    <!--Grid column-->
                    <div class="col-md-6 mb-2">
    
                      <!--Descripcion-->
                      <div class="md-form">
                        <input type="text" id="Descripcion" class="form-control">
                        <label for="Descripcion" class="">Descripcion</label>
                      </div>
    
                    </div>
                    <!--Grid column-->
    
                  </div>
                  <!--Grid row-->
    
                  <div class="row">
                    <!--Grid column-->
                    <div class="col-lg-6 col-md-6 mb-4">
        
                        <label for="Categoria">Categoria</label>
                        <select class="custom-select d-block w-100" id="Categoria" required>
                            <option value="">Elige...</option>
                            <option>Electronicos</option>
                            <option>Ropa</option>
                            <option>Electrodomesticos</option>
                            <option>Calzado</option>
                            <option>Varios</option>
                        </select>
                    </div>
                    <!--Grid column-->

                    <!--Grid column-->
                    <div class="col-lg-6 col-md-6 mb-4">
        
                        <label for="Estado">Estado</label>
                        <select class="custom-select d-block w-100" id="Estado" required>
                            <option value="">Elige...</option>
                            <option>Nuevo</option>
                            <option>SemiNuevo</option>
                            <option>Usado</option>
                        </select>
                    </div>
                    <!--Grid column-->
                </div>
                    
                <div class="row">
                  <!--Grid column-->
                  <div class="col-md-5 mb-2">
                    <!--PrecioOriginal-->
                    <div class="md-form mb-5">
                        <input type="number" id="PrecioOriginal" class="form-control" placeholder="1250.00">
                        <label for="PrecioOrginal" class="">Precio Original</label>
                    </div>
                  </div>

                  <!--Grid column-->
                  <div class="col-md-5 mb-2">
                    <!--PrecioActual-->
                    <div class="md-form mb-5">
                        <input type="number" id="PrecioActual" class="form-control" placeholder="1250.00" required>
                        <label for="PrecioActual" class="">Precio Actual</label>
                    </div>
                  </div>

                  <!--Grid column-->
                  <div class="col-md-2 mb-2">
                    <!--Cantidad-->
                    <div class="md-form mb-5">
                        <input type="number" id="Cantidad" class="form-control" placeholder="1250" required>
                        <label for="Cantidad" class="">Cantidad</label>
                    </div>
                  </div>
                </div>
                  <!--InformacionAdicional-->
                  <div class="md-form mb-5">
                    <input type="text" id="InfoAdicional" class="form-control" placeholder="Que mas quieres mencionar del producto?">
                    <label for="InfoAdicional" class="">Informacion Adicional</label>
                  </div>
                  <input class="my-2" type="file" id="input" accept="image/*">
                  <div id="Imagenes" class="row"></div>
                  <hr class="mb-4">
                  <button class="btn btn-primary btn-lg btn-block" type="button" id="btnAgregar">Agregar Producto</button>
                </form>
              </div>
              <!--/.Card-->
            </div>
            <!--Grid column-->
          </div>
          <!--Grid row-->
        </div>
        <!-- Flexbox container for aligning the toasts -->
        <div aria-live="polite" aria-atomic="true" class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
            <!-- Then put toasts within -->
            <div class="toast" role="alert" aria-live="assertive" data-delay="2500" aria-atomic="true" style="position: fixed; top: 70vh; right: 40vw;z-index: 1;">
                <div class="toast-header">
                <img src="..." class="rounded mr-2" alt="...">
                <strong id="titulo_toast" class="mr-auto" style="color:whitesmoke;font-size: 1.5rem;"></strong>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>
                <div id="texto_toast" class="toast-body"></div>
            </div>
        </div>
      </main>
      <!--Main layout-->
    <% include ../partials/footer %>
    <script>
        var imagenes = [undefined, undefined, undefined, undefined, undefined, undefined];
        var links_imagenes = [];
        const ref = firebase.storage().ref();
        $(document).ready(function(){
            $("#btnAgregar").click(function(){
              // se agrega el loader para mostrar que esta modificando
              $('.card-body').append('<div class="row"><div class="col-md-12"><div id="loader" class="lds-facebook d-block mx-auto"><div></div><div></div><div></div></div></div></div>');
              var num_imagenes = 0;
              var num_total_imagenes = 0;
              imagenes.forEach( imagen => { if (imagen != undefined) num_total_imagenes ++; });
              imagenes.forEach( imagen => {
                if (imagen != undefined) {
                  var file_to_upload = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)+imagen.name;
                  const task = ref.child(file_to_upload).put(imagen);
                  task.then((snapshot) => {
                    ref.child(file_to_upload).getDownloadURL().then((link) => {
                      links_imagenes.push(link.substring(0, link.indexOf('?')));
                      num_imagenes++;
                      if (num_imagenes == num_total_imagenes) {
                        guardarProducto(links_imagenes);
                      }
                    });  
                  });
                }
              });   
            });
        });
        const inputElement = document.getElementById("input");
        inputElement.addEventListener("change", handleFiles, false);
        function handleFiles() {
            for (let x = 0; x < 6; x++) {
                if (imagenes[x] == undefined) {
                    imagenes[x] = this.files[0];
                    $('#Imagenes').append('<a id="'+x+'" onclick="eliminar(this)" class="background-btn btn btn-outline-white waves-effect waves-light" target="_blank" role="button">'+imagenes[x].name+'</a>');
                    $('#'+x).hover( e => {
                      $('#'+x).text('Eliminar Imagen');
                    }, e2 => {
                      $('#'+x).text(imagenes[x].name);
                    });
                    break;
                }
                if (x == 5) {
                    alert('Ya eligiste el maximo de imagenes, elimina una antes de intentar subir otra');
                }
            }
        }
        function eliminar(imagen) {
            $('#'+imagen.id).remove();
            imagenes[imagen.id] = undefined;
        }

        function guardarProducto(images_to_upload) {
          var xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
              if (this.readyState == 4 && this.status == 200) {
                  // Aqui ya se termino la operacion
                  $('#loader').remove();
                  $('#titulo_toast').text('Operacion Exitosa');
                  $('#texto_toast').text('Se agrego el nuevo producto con exito');
                  $('.toast-header').css('background-color','green');
                  $('.toast').toast('show');
                  document.getElementById('Descripcion').value = '';
                  document.getElementById('Nombre').value = '';
                  document.getElementById('Categoria').value = '';
                  document.getElementById('Estado').value = '';
                  document.getElementById('PrecioActual').value = '';
                  document.getElementById('PrecioOriginal').value = '';
                  document.getElementById('Cantidad').value = '';
                  document.getElementById('InfoAdicional').value = '';
                  links_imagenes = [];
                  imagenes = [undefined, undefined, undefined, undefined, undefined, undefined];
                  document.getElementById("input").value = '';
                  $('#Imagenes').empty();
                  $('.toast').on('hidden.bs.toast', function () {
                      window.scroll({
                          top: 0, 
                          left: 0, 
                          behavior: 'smooth'
                      });
                      setTimeout(function() {
                          document.getElementById('Nombre').focus();
                      }, 750);
                  });
              } else {
                  if (this.readyState == 4) {
                      // hubo un error
                      $('#titulo_toast').text('Ocurrio Un Error');
                      $('#titulo_toast').text('No se pudo agregar correctamente el producto, vuelve a intentarlo');
                      $('.toast-header').css('background-color','red');
                      $('.toast').toast('show');
                  }
              }
          };
          xhttp.open('POST', '/AgregarProducto/Guardar', true);
          xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
          var Nombre = document.getElementById('Nombre').value;
          var Imagenes = '';
          images_to_upload.forEach( link => {
            Imagenes += link+',';
          });
          var Descripcion = document.getElementById('Descripcion').value;
          var Categoria = document.getElementById('Categoria').value;
          var Estado = document.getElementById('Estado').value;
          var PrecioActual = document.getElementById('PrecioActual').value;
          var PrecioOrginal = document.getElementById('PrecioOriginal').value;
          var Cantidad = document.getElementById('Cantidad').value;
          var InformacionAdicional = document.getElementById('InfoAdicional').value;
          var data = "CantidadDisponible="+Cantidad+'&Nombre='+Nombre+'&Descripcion='+Descripcion+'&Categoria='+
              Categoria+'&Estado='+Estado+'&PrecioActual='+PrecioActual+'&PrecioOriginal='+PrecioOrginal+
              '&InformacionAdicional='+InformacionAdicional+'&Imagenes='+Imagenes;
          xhttp.send(data);
        }
        </script>
  </body>
</html>
