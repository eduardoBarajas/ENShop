<!DOCTYPE html>
<html class="no-js" lang="zxx">
<% include ../partials/head %>
<style>
    .PrecioOriginal {
        -webkit-text-decoration-line: line-through; /* Safari */
        text-decoration-line: line-through; 
    }
    img {
      max-width: 100%;
      max-height: 30vh;
      height: 100vh;
    }
</style>
<% include ../partials/navbar %>
<script>
    document.getElementById('carrito-id').remove();
</script>
    <body>
        <div class="container px-0" style="margin-top: 4.5rem;">
            <!--Navbar-->
            <nav class="navbar navbar-expand-lg navbar-dark mdb-color lighten-3 mt-3 mb-5" style="background-color: tomato!important;">

                <span><button onclick="parent.location='/AgregarProducto'" type="button" class="btn btn-secondary" style="background-color: tomato!important;">Agregar Producto</button></span>
                <span><button onclick="parent.location='/Admin/MostrarPedidos'" type="button" class="btn btn-secondary" style="background-color: tomato!important;">Mostrar Pedidos</button></span>
                <!-- Navbar brand -->
                <span class="navbar-brand">Categorias:</span>
    
                <!-- Collapse button -->
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#basicExampleNav"
                aria-controls="basicExampleNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
                </button>
    
                <!-- Collapsible content -->
                <div class="collapse navbar-collapse" id="basicExampleNav">
    
                <!-- Links -->
                <ul class="navbar-nav mr-auto">
                    <li id="btn_opcion_1" class="nav-item active">
                    <a class="nav-link" onclick="getProductos('')">Todos</a>
                    </li>
                    <li id="btn_opcion_2" class="nav-item">
                        <a class="nav-link" onclick="getProductos('Ropa')">Ropa</a>
                    </li>
                    <li id="btn_opcion_3" class="nav-item">
                        <a class="nav-link"  onclick="getProductos('Calzado')">Calzado</a>
                    </li>
                    <li id="btn_opcion_4" class="nav-item">
                        <a class="nav-link"  onclick="getProductos('Electronicos')">Electronicos</a>
                    </li>
                    <li id="btn_opcion_5" class="nav-item">
                        <a class="nav-link"  onclick="getProductos('Electrodomesticos')">Electrodomesticos</a>
                    </li>
                    <li id="btn_opcion_6" class="nav-item">
                        <a class="nav-link"  onclick="getProductos('Varios')">Varios</a>
                    </li>
                </ul>
    
                <form class="form-inline">
                    <div class="md-form my-0">
                        <input id="busqueda_input" onkeyup="buscarProducto()" class="form-control mr-sm-2" type="text" placeholder="Buscar" aria-label="Buscar">
                    </div>
                </form>
                </div>
                <!-- Collapsible content -->
    
            </nav>
            <!--/.Navbar-->
            <!--Section: Products v.3-->
            <section class="text-center mb-4 mx-4">
                <!--Grid row-->
                <div id="section_productos" class="row wow fadeIn">
                    <!--Aqui van los productos-->
                </div>
                <!--Grid row-->
            </section>
            <!--Section: Products v.3-->
        </div>
        <div class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header" style="background-color: tomato;color: whitesmoke;">
                        <h5 class="modal-title">Eliminar Producto</h5>
                        <button id="btn_cerrar_modal" type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p id="texto_modal"> Estas seguro que quieres eliminar este producto? </p>
                    </div>
                    <div class="modal-footer">
                        <button id="btn_modal_si" type="button" class="btn btn-primary" style="background-color: tomato!important;">Si</button>
                        <button id="btn_modal_no" type="button" class="btn btn-primary" data-dismiss="modal">No</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Flexbox container for aligning the toasts -->
        <div aria-live="polite" aria-atomic="true" class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
            <!-- Then put toasts within -->
            <div class="toast" role="alert" aria-live="assertive" data-delay="1000" aria-atomic="true" style="position: fixed; top: 60vh; right: 40vw;z-index: 1;">
                <div class="toast-header" style="max-height:10vh;">
                <img src="..." class="rounded mr-2" alt="...">
                <strong id="titulo_toast" class="mr-auto" style="color:whitesmoke;font-size: 1.5rem;"></strong>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>
                <div id="texto_toast" class="toast-body"></div>
            </div>
        </div>
        <% include ../partials/footer %>
        <script>
            const ref = firebase.storage().ref();
            $(document).ready(function() {
                $.ajax({
                    url: '/ObtenerTodosLosProductos',
                    type: 'GET',
                    success: function(result) {
                        loadProducts(result);
                    }
                });
                // toast
                $('#titulo_toast').text('Operacion Exitosa');
                $('#texto_toast').text('Se elimino el nuevo producto con exito');
                $('.toast-header').css('background-color','green');
                $('#btn_cerrar_modal').click( e => { $('.modal').hide(); });
                $('#btn_modal_si').click( e => {
                    // hacer algo
                    $.ajax({
                        url: '/ObtenerProductoPorID/'+$('#btn_modal_si').data('id_producto'),
                        type: 'GET',
                        success: function(producto) {
                            console.log(producto);
                            let imagenes_eliminadas = 0;
                            producto.ImagenesProducto.split(',').forEach( imagen => {
                                ref.child(imagen.split('/')[7].split('?')[0]).delete().then(function() {
                                    // File deleted successfully
                                    imagenes_eliminadas++;
                                    if (imagenes_eliminadas == producto.ImagenesProducto.split(',').length) {
                                        $.ajax({
                                            url: '/EliminarProducto/'+$('#btn_modal_si').data('id_producto'),
                                            type: 'DELETE',
                                            success: function(data, status) {
                                                if (data == 'ProductoNoEliminado') {
                                                    $('#titulo_toast').text('No Se Pudo Eliminar');
                                                    $('#texto_toast').text('Tiene pedidos realizados con este producto');
                                                    $('.toast-header').css('background-color','tomato');
                                                } else {
                                                    $('#titulo_toast').text('Producto Eliminado');
                                                    $('#texto_toast').text('Se elimno el producto satisfactoriamente');
                                                    $('.toast-header').css('background-color','tomato');
                                                    $('#prod_'+$('#btn_modal_si').data('id_producto')).remove();
                                                }
                                                // Do something with the result
                                                $('.toast').toast('show');
                                                $('.modal').hide();
                                            }
                                        });
                                    }
                                }).catch(function(error) {
                                    // Uh-oh, an error occurred!
                                    console.log('Algo malo paso: '+error);
                                });
                            });
                        }
                    });
                });
                $('#btn_modal_no').click( e => { $('.modal').hide(); });
            });
            function getProductos(categoria) {
                $.ajax({
                    url: '/ObtenerProductos/'+categoria,
                    type: 'GET',
                    success: function(data, status) {
                        if (status == 'success') {
                            if (data.length > 0) {
                                setOpcionSeleccionada(categoria);
                                loadProducts(data);
                            } else {
                                $('#titulo_toast').text('No Hay Productos');
                                $('#texto_toast').text('No se encontraron en '+categoria);
                                $('.toast-header').css('background-color','tomato');
                                $('.toast').toast('show');
                            }
                        }
                    }
                });
            }
            function setOpcionSeleccionada(categoria) {
                for (let x = 0; x < 6; x++) {
                    if ($('#btn_opcion_'+(x+1)).hasClass('active')) {
                        $('#btn_opcion_'+(x+1)).removeClass('active');
                    }
                }
                switch (categoria) {
                    case '':  $('#btn_opcion_1').addClass('active');break;
                    case 'Ropa':  $('#btn_opcion_2').addClass('active');break;
                    case 'Calzado':  $('#btn_opcion_3').addClass('active');break;
                    case 'Electronicos':  $('#btn_opcion_4').addClass('active');break;
                    case 'Electrodomesticos':  $('#btn_opcion_5').addClass('active');break;
                    case 'Varios':  $('#btn_opcion_6').addClass('active');break;
                }
            }
            function buscarProducto(event) {
                if ($('#busqueda_input').val() == '') {
                    getProductos('');
                    console.log('ENTRO AQUI');
                } else {
                    $.ajax({
                        url: '/BuscarProductos/'+$('#busqueda_input').val(),
                        type: 'GET',
                        success: function (data, status) {
                            if (status == 'success') {
                                loadProducts(data);
                            }
                        }
                    });
                }
            }
            function loadProducts(productos) {
                $('#section_productos').empty();
                productos.forEach( producto => {
                    let node = '<div id="prod_'+producto._id+'" class="col-lg-3 col-md-3 mb-4"><div class="card"><div class="view overlay"><img id="img-'+producto._id+'" src="'+producto.ImagenesProducto.split(',')[0]+'" class="card-img-top" alt=""><a href="/Producto/'+producto._id+'">';
                    node += '<div class="mask rgba-white-slight"></div></a></div><div class="card-body text-center"><a class="grey-text"><h5>'+producto.Categoria+'</h5></a><h5><strong><a href="/Producto/'+producto._id+'" class="dark-grey-text">';
                    node += producto.Nombre+'<span class="mx-2 badge badge-pill danger-color">'+producto.Estado+'</span></a></strong></h5><div class="row"><div class="col-md-6"><button id="btnEditar" onclick="parent.location=\'/ModificarProducto/'+producto._id+'\'" class="btn btn-primary btn-md btn-block mx-auto px-0"';
                    node += 'type="button">Editar</button></div><div class="col-md-6"><button onclick="eliminarProducto(\''+producto._id+'\')" class="btn btn-primary btn-md btn-block mx-auto px-0" style="background-color: tomato!important;" type="button">';
                    node += 'Eliminar</button></div></div></div></div></div>';
                    $('#section_productos').append(node);
                });
            }
            function eliminarProducto(id) {
                $('.modal').show();
                $('#btn_modal_si').data('id_producto', id);
            }
        </script>
    </body>
</html>