<!DOCTYPE html>
<html class="no-js" lang="zxx">
<% include ../partials/head %>
<% include ../partials/navbar %>
<script>
    document.getElementById('carrito-id').remove();
</script>
    <body>
    <!--Main layout-->
    <main class="mt-5 pt-4">
        <div class="container wow fadeIn">
            <div class="row">
                <div class="col-md-4">
                    <div class="md-form">
                        <input type="text" id="IdCarrito" class="form-control">
                        <label for="IdCarrito" class="">Numero de identificacion del pedido</label>
                    </div>
                </div>
                <div class="col-md-2 mt-2">
                    <button id="btnBuscarCarrito" class="btn btn-primary btn-md btn-block" type="button">Buscar Pedido</button>
                </div>
            </div>
            <!--Este div le da el espacio cuando el contenido quiere ser ocultado-->
            <div id="spacer-div" style="min-height: 40vh;">
                <div class="row">
                    <div class="col-md-12 py-0 my-4">
                        <img src="/img/svg/pedidos.svg" alt="" class="mx-auto my-2" style="width: 100%; height: 40vh;" />
                    </div>
                    <div class="col-md-12 text-center">
                        <p style="font-size: 3rem;">Rastrea tu pedido aqui</p>
                    </div>
                </div>
            </div>
            <!--todo el contenido es escondido hasta que se busca el carrito-->
            <div id="content" hidden>
                <div class="row">
                    <!--Grid column-->
                    <div class="col-md-12 mb-4">
            
                    <!-- Heading -->
                    <h4 class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Tus Pedidos</span>
                        <span id="cantidad_productos_pedidos" class="badge badge-secondary badge-pill">3</span>
                    </h4>
            
                    <!-- Cart -->
                    <ul id="carrito" class="list-group mb-3 z-depth-1">
                        <div id="pedidos_elements"></div>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Total (MX)</span>
                            <strong id="total_precio"></strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-start">
                            <span>Datos De Envio:</span>
                            <strong class="mx-2" id="datos_envio"></strong>
                        </li>
                    </ul>
                    <div class="row">
                            <div class="col-12 col-md-2 px-0 text-center" >
                                <span style="font-size: 1.2rem;">Estado Actual Pedido:</span>
                            </div>
                            <div class="col-12 col-md-1 px-0 text-center">
                                <span style="font-size: 1.2rem;" id="estado_actual" class="badge red mr-1"></span>
                            </div>
                        </div>
                    <!-- Cart -->
                    
                    <!-- Promo code -->
                    <!-- Promo code -->
            
                    </div>
                    <!--Grid column-->
                </div>
                <!--Grid row-->
            </div>
        </div>
      </main>
      <!-- Flexbox container for aligning the toasts -->
      <div aria-live="polite" aria-atomic="true" class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
            <!-- Then put toasts within -->
            <div class="toast" role="alert" aria-live="assertive" data-delay="2500" aria-atomic="true" style="position: fixed; top: 70vh; right: 40vw;z-index: 1;">
                <div class="toast-header">
                <img src="..." class="rounded mr-2" alt="...">
                <strong id="titulo_toast" class="mr-auto" style="color:whitesmoke;font-size: 1.5rem;"></strong>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>
                <div id="texto_toast" class="toast-body"></div>
            </div>
        </div>
      <!--Main layout-->
        <% include ../partials/footer %>    
        <script>
            $(document).ready(function() {
                $('#btnBuscarCarrito').click(e => {
                    ObtenerCarrito($('#IdCarrito').val());
                });
            });
            function ObtenerCarrito(id) {
                console.log(id);
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        $.ajax({
                            url: '/ObtenerCarritoInfo/'+id,
                            type: 'GET',
                            success: function(data) {
                                let datos = 'Enviado a '+data.Nombre+' '+data.Apellido;
                                datos += ', en la direccion '+data.Direccion+', '+data.Direccion2+', '+data.CP+', Ensenada, B.C';
                                $('#datos_envio').text(datos);
                                if (data.Completado) {
                                    $('#estado_actual').text('COMPLETADO');
                                } else {
                                    if (data.Enviado) {
                                        $('#estado_actual').text('ENVIADO');
                                    } else {
                                        $('#estado_actual').text('PAGADO');
                                    }
                                }
                                
                                console.log(data);
                            }
                        });
                        data = JSON.parse(this.responseText);
                        $('#pedidos_elements').empty();
                        let total = 0;
                        data.forEach( arr => {
                            total += arr['producto'].PrecioActual;
                            console.log(arr['producto']);
                            elemento = '<li class="list-group-item d-flex justify-content-between lh-condensed">';
                            elemento += '<div><h6 class="my-0">'+arr['producto'].Nombre+'</h6><small class="text-muted">';
                            elemento += arr['producto'].Descripcion+'</small></div><span class="text-muted">$'+arr['producto'].PrecioActual+'</span></li>';
                            $('#pedidos_elements').append($(elemento));
                        });
                        console.log(total);
                        $('#total_precio').text('$'+total);
                        $('#cantidad_productos_pedidos').text(data.length);
                        $('#spacer-div').attr('hidden', 'true');
                        $('#content').removeAttr('hidden');
                        $('#titulo_toast').text('Pedido');
                        $('#texto_toast').text('Se encontro el pedido con exito');
                        $('.toast-header').css('background-color','green');
                        $('.toast').toast('show');
                    } else {
                        if (this.readyState == 4 && this.status == 404) {
                            $('#spacer-div').removeAttr('hidden');
                            $('#content').attr('hidden', 'true');
                            $('#titulo_toast').text('Pedido');
                            $('#texto_toast').text('No se encontro un carrito para ese codigo');
                            $('.toast-header').css('background-color','tomato');
                            $('.toast').toast('show');
                        }
                    }
                };
                xhttp.open("GET", '/ObtenerCarrito/'+id, true);
                xhttp.send();
            }
        
        </script>    
    </body>
</html>