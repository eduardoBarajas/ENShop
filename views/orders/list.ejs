<!DOCTYPE html>
<html class="no-js" lang="zxx">
<% include ../partials/head %>
<% include ../partials/navbar %>

<body>
    <!--Main layout-->
    <main class="mt-5 pt-4">
        <div class="container wow fadeIn">
            <div class="row">
                <div class="col-md-4">
                    <div class="md-form">
                        <input type="text" id="IdCarrito" class="form-control">
                        <label for="IdCarrito" class="">Numero de identificacion del pedido</label>
                    </div>
                </div>
                <div class="col-md-2 mt-2">
                    <button id="btnBuscarCarrito" class="btn btn-primary btn-md btn-block" type="button">Buscar
                        Pedido</button>
                </div>
            </div>
            <!--Este div le da el espacio cuando el contenido quiere ser ocultado-->
            <div id="spacer-div" style="min-height: 40vh;">
                <div class="row">
                    <div class="col-md-12 py-0 my-4">
                        <img src="/img/svg/pedidos.svg" alt="" class="mx-auto my-2"
                            style="width: 100%; height: 40vh;" />
                    </div>
                    <div class="col-md-12 text-center">
                        <p style="font-size: 3rem;">Rastrea tu pedido aqui</p>
                    </div>
                </div>
            </div>
            <!--todo el contenido es escondido hasta que se busca el carrito-->
            <div id="content" hidden>
                <div class="row">
                    <!--Grid column-->
                    <div class="col-md-12 mb-4">

                        <!-- Heading -->
                        <h4 class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-muted">Tus Pedidos</span>
                        </h4>

                        <!-- Pedidos -->
                        <ul id="pedidos_list" class="list-group">
                        </ul>
                        <!-- Pedidos -->

                        <!-- Promo code -->
                        <!-- Promo code -->

                    </div>
                    <!--Grid column-->
                </div>
                <!--Grid row-->
            </div>
        </div>
    </main>
    <!-- Flexbox container for aligning the toasts -->
    <div aria-live="polite" aria-atomic="true" class="d-flex justify-content-center align-items-center"
        style="min-height: 200px;">
        <!-- Then put toasts within -->
        <div class="toast" role="alert" aria-live="assertive" data-delay="2500" aria-atomic="true"
            style="position: fixed; top: 70vh; right: 40vw;z-index: 1;">
            <div class="toast-header">
                <img src="..." class="rounded mr-2" alt="...">
                <strong id="titulo_toast" class="mr-auto" style="color:whitesmoke;font-size: 1.5rem;"></strong>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div id="texto_toast" class="toast-body"></div>
        </div>
    </div>
    <!--Main layout-->
    <% include ../partials/footer %>
    <script>
        $(document).ready(function () {
            if (localStorage.getItem('userSession') !== null) {
                $.ajax({
                    url: '/Carts/GetAll/User/' + JSON.parse(localStorage.getItem('userSession'))['idUser'],
                    type: 'GET',
                    success: function (data, status) {
                        if (status !== 'nocontent') {
                            data.forEach( carrito => {
                                getData(carrito._id);
                            });
                        } else {
                            $('#spacer-div').removeAttr('hidden');
                            $('#content').attr('hidden', 'true');
                            $('#titulo_toast').text('Pedido');
                            $('#texto_toast').text('No haz realizado ningun pedido.');
                            $('.toast-header').css('background-color', 'tomato');
                            $('.toast').toast('show');
                        }
                    }
                }).fail(function (jqXHR, textStatus, errorThrown) {
                if (jqXHR.status === 0 || jqXHR.status == 500) {
                    $('#titulo_toast').text('Error De Conexion');
                    $('#texto_toast').text('Hubo un problema con la conexion con el servidor. ');
                    $('.toast-header').css('background-color', 'tomato');
                    $('.toast').toast('show');
                }
            });
            }
            $('#btnBuscarCarrito').click(e => {
                $('#pedidos_elements').empty();
                getData($('#IdCarrito').val());
            });
        });
        function getData(id) {
            console.log(id);
            $.ajax({
                url: '/Carts/id/' + id,
                type: 'GET',
                success: function (data, status) {
                    console.log(data);
                    if (status !== 'nocontent') {
                        let state = '';
                        if (data.sent)
                            state = 'COLOCADO';
                        if (data.payed)
                            state = 'PAGADO';
                        if (data.delivered)
                            state = 'ENVIADO';
                        if (data.completed)
                            state = 'COMPLETADO';
                        let link = '/Pedidos/id/';
                        let node = `<a id="pedido_item_${data._id}" onclick="parent.location='${link}${data._id}'" data-toggle="collapse" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">`+
                                    `<div class="flex-column">Cliente: ${data.name} ${data.lastNames}<p><small>Direccion Envio: ${data.address}, ${data.address2}, ${data.cp}, Ensenada, ` + 
                                    `B.C.</small></p><small>Estado: </small><span id="estado_pedido_${data._id}" class="badge badge-primary badge-pill">${state}</span> <small>Realizado: </small><span id="created_${data._id}" class="badge badge-primary badge-pill">${data.creationDate}</span></div>`;          
                        $('#pedidos_list').append(node);
                        $('#spacer-div').attr('hidden', 'true');
                        $('#content').removeAttr('hidden');
                        $('#titulo_toast').text('Pedido');
                        $('#texto_toast').text('Se encontro el pedido con exito');
                        $('.toast-header').css('background-color', 'green');
                        $('.toast').toast('show');
                    } else {
                        $('#spacer-div').removeAttr('hidden');
                        $('#content').attr('hidden', 'true');
                        $('#titulo_toast').text('Pedido');
                        $('#texto_toast').text('No se encontro un carrito para ese codigo');
                        $('.toast-header').css('background-color', 'tomato');
                        $('.toast').toast('show');
                    }
                }
            }).fail(function (jqXHR, textStatus, errorThrown) {
                if (jqXHR.status === 0 || jqXHR.status == 500) {
                    $('#titulo_toast').text('Error De Conexion');
                    $('#texto_toast').text('Hubo un problema con la conexion con el servidor. ');
                    $('.toast-header').css('background-color', 'tomato');
                    $('.toast').toast('show');
                }
            });
        }

    </script>
</body>

</html>